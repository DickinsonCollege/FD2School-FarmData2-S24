<!DOCTYPE html>
<html>
<head></head>
  <title>Harvest Report</title>
</head>
<body>

<h1 data-cy="page-header">Harvest Report</h1>
<p>This page is a <i>mockup</i> of a simplified harvest report</p>

<div id="app" v-cloak>
  <label for="reportTitle">Title:</label>
  <input type="text" id="reportTitle" name="reportTitle" v-model="reportTitle" data.cy="header-exist">

  <br>
  <br>

  <label for="start_date">Start Date:</label>
  <input type="date" id="start_date" name="start_date" min="2014-01-01" max="2022-01-01" v-model="reportStartDate" data-cy="start-date">

  <label for="end_date">End Date:</label>
  <input type="date" id="end_date" name="end_date" min="2020-05-05" max="2022-01-01" v-model="reportEndDate" data-cy="end-date">

  <br>
  <br>

  <label for="crop">Crop:</label>
  <select v-model="reportSelectedCrop" id="crop" name="crop" data-cy="crop-dropdown">
    <option v-for="crop in cropNames" :value="crop">{{ crop }}</option>
  </select>

  <label for="field">Area:</label>
  <select v-model="reportSelectedArea" id="area" name="area">
    <option v-for="area in areaList" :value="area">{{ area }}</option>
  </select>

  <button @click="addHarvestLog" :disabled="reportTitle.trim() === ''" data-cy="generate-button">Generate Report</button>


</div>

<hr>
<div>
<h1>{{reportTitle ? reportTitle : "Mock Harvest Report"}}</h1>

</div>
<p>Details:</p>
<ul>
  <li data-cy="farm-name"><b>Farm:</b>{{ farm }}</li>
  <li daya-cy="username"><b>User:</b>{{ user }}</li>
  <li><b>Language:</b><span data-cy="language">{{ language }}</span></li>
</ul>
<ul>
  <li><b>Start</b>: {{ reportStartDate }}</li>
  <li><b>End</b>: {{ reportEndDate }}</li>
  <li><b>Crop</b>: {{ reportSelectedCrop }}</li>
</ul>

<div v-if="harvestLogs.length > 0">
  <table border="1">
    <thead>
      <tr>
        <th>Row</th>
        <th>Date</th>
        <th>Area</th>
        <th>Crop</th>
        <th>Yield</th>
        <th>Units</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(log, index) in harvestReportRows" :key="index">
        <td>{{ index + 1 }}</td>
        <td>{{ row.date }}</td>
        <td>{{ row.area }}</td>
        <td>{{ row.crop }}</td>
        <td>{{ row.yield }}</td>
        <td>{{ row.units }}</td>
      </tr>
    </tbody>
  </table>
</div>
<div v-else>
  <p>No matching records found.</p>
</div>

<script src="https://unpkg.com/vue@2"></script>
<script>
  var harvest = new Vue({
    el: '#app',
    created() {
      console.log("HarvestReport Vue instance created!");
      getIDToCropMap().then((theMap) => {
          this.idToCropMap = theMap;
        })
        .catch((err) => {
          console.log("Error occurred", err);
        });
    },

    data: {
      reportTitle: 'My Sample Harvest Report',
      reportStartDate: '2020-05-05',
      reportEndDate: '2020-05-15',
      reportSelectedCrop: "Kale",
      reportSelectedArea: "ALL",
      areaList: ["ALL", "SQ7", "Chuau-1"],
      harvestLogs: [],
      farm: '',
      user: '',
      language: '',
      idToCropMap: new Map(),
      allHarvestLogs: [],
                           
    },
    settingMaxMin: {
      minStartDate: function() {
        return this.reportEndDate;
      },
      maxEndDate: function() {
        return this.reportStartDate;
      }
    },
    computed: {
      cropNames: function() {
        return Array.from(this.idToCropMap.values());
      },
      harvestReportRows() {
        let tableRows = [];
        for (let log of this.allHarvestLogs) {
            if (log.crop === this.reportSelectedCrop) {
                let tableRow = {
                    date: dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                    area: log.movement.area[0],
                    crop: this.idToCropMap.get(log.data.crop_tid),
                    yield: harvestQuantity ? harvestQuantity.value : null,
                    units: harvestQuantity ? harvestQuantity.unit.name : null,
                };
                tableRows.push(tableRow);
        }
    }
        return tableRows;
    }
        },
    methods: {
  addHarvestLog: function() {
    if (this.reportTitle.trim() !== '') {
        let startTimestamp = dayjs(this.reportStartDate).unix();
        let endTimestamp = dayjs(this.reportEndDate).unix();
        let rstring = `/log.json?type=farm_harvest&timestamp[ge]=${startTimestamp}&timestamp[le]=${endTimestamp}`;

        console.log("Start Timestamp:", startTimestamp);
        console.log("End Timestamp:", endTimestamp);
        console.log("Request:", rstring);

        getAllPages(rstring, this.allHarvestLogs)
        .then(() => {
          console.log("harvest logs retrieved:", this.allHarvestLogs);
        })
        .catch((err) => {
          console.error("Error occurred", err);
        });

      axios.get('/farm.json').then((response) => {
        this.farm = response.data.name;
        this.user = response.data.user.name;
        this.language = response.data.language;
      })
      .catch((error) => {
        console.log("Error Occurred");
        console.log(error);
      });
      
      this.reportTitle = '';
    }
  }
}
  });
  Vue.config.devtools = true; 
</script>

</body>
</html>
