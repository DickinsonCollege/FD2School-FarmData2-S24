<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>My Sample Harvest Report Page</title>
        <!-- <style>
            [v-cloak] {
                display:none;
            }
        </style> -->
    </head>
    <body>

        <!-- <script src="https://unpkg.com/vue@2"></script>
        <script> src="https://unpkg.com/dayjs"</script> -->

        <div id="harvestReport" v-cloak>

            <label for="reportTitle">Title:</label>
            <input type="text" id="title" name="title" v-model="reportTitle"/>

            <label for="reportStartDate">Start:</label>
            <input type="date" v-bind:max="reportEndDate" id="reportStartDate" name="reportStartDate" value="2020-05-05" v-model="reportStartDate"/>

            <label for="reportStartDate">Start:</label>
            <input type="date" v-bind:min="reportStartDate" id="reportEndDate" name="reportEndDate" value="2020-05-15" v-model="reportEndDate"/>

            <label for="reportCrops">Crop:</label>
            <select v-model="reportSelectedCrop" id="cropCrops" v-model="crop">
                <option v-for="crop in cropNames">{{ crop }}</option>
            </select>

            <label for="reportAreas">Area:</label>
            <select v-model="reportSelectedArea" id="reportAreas">
                <option v-for="area in areaNames">{{ area }}</option>
            </select>

            <input type="button" value="Generate Report" @click="generateReport"/>

            <h1>{{ header.toLocaleUpperCase() ? header : "Mock Harvest Report"}}</h1>

            <ul>
                <li><strong>Start: </strong>{{ reportStartDate }}</li>
                <li><strong>End: </strong>{{ reportEndDate }}</li>
                <li><strong>Crop: </strong>{{ reportSelectedCrop }}</li>
                <li><strong>Area: </strong>{{ reportSelectedArea }}</li>
                <li><strong>Farm: </strong>{{ farm }}</li>
                <li><strong>User: </strong>{{ user }}</li>
                <li><strong>Language: </strong>{{ language }}</li>
            </ul>

            <div v-if="harvestReportRows.length > 0">
                <table border="1">
                    <tr>
                        <th>Row</th>
                        <th>Date</th>
                        <th>Area</th>
                        <th>Crop</th>
                        <th>Yield</th>
                        <th>Units</th>
                    </tr>
                    <tr v-for="tableCol in harvestReportRows">
                        <td>{{ index+1 }}</td>
                        <td>{{ tableCol.date }}</td>
                        <td>{{ tableCol.area }}</td>
                        <td>{{ tableCol.crop }}</td>
                        <td>{{ tableCol.yield }}</td>
                        <td>{{ tableCol.units }}</td>
                    </tr>
                </table>
            </div>
            <p v-if="harvestReportRows.length === 0">There is currently no harvest report logs available.</p>
        </div>

        <script>
            var harvestReport = new Vue({
                el: '#harvestReport',
                data: {
                    header: 'Mock Harvest Report',
                    reportTitle: '',
                    reportStartDate: '',
                    reportEndDate: '',
                    reportSelectedCrop: 'Kale',
                    reportSelectedArea: 'ALL',
                    reportCrops: [],
                    reportAreas: [],
                    reportTable: [],        
                    harvestLogs: [],        // used to store the harvest log reports  
                    farm: '',
                    user: '',
                    language: '',
                    idToCropMap: new Map(),
                    idToAreaMap: new Map(),
                },
                computed: {
                    cropNames: function() {
                        return Array.from(this.idToCropMap.values());
                    },
                    areaNames: function() {
                        return Array.from(this.idToAreaMap.values());
                    },
                    harvestReportRows() {
                        let tableRows = []
                        for (let log of this.harvestLogs) {
                            let tableRow = {
                                date: log.timestamp,
                                area: log.area[0].name,
                                crop: this.idToCropMap.get(log.data.crop_tid),
                                yield: log.quantity[0].value,
                                units: log.quantity[0].unit.name
                            }
                            tableRows.push(tableRow)
                        }
                        return tableRows
                    }
                },
                created() {
                    console.log("HarvestReport Vue instance created!")
                    getIDToCropMap()
                    .then((theCropMap) => {
                        this.idToCropMap = theCropMap;
                        console.log("idToCropMap variable created");
                    })
                    .catch((error) => {
                        console.log("CropMap not received / Not created correctly");
                    });
                    getIDToAreaMap()
                    .then((theAreaMap) => {
                        this.idToAreaMap = theAreaMap;
                        console.log("idToAreaMap variable created");
                    })
                    .catch((error) => {
                        console.log("AreaMap not received / Not created correctly");
                    });
                },
                methods: {
                    generateReport: function() {
                        // Request the farm information from the server.
                        axios.get('/farm.json')
                        .then((response) => {
                            this.farmName = response.data.name;
                            this.currentUser = response.data.user.name;
                            this.language = response.data.languages.en.name;
                        })
                        .catch((error) => {
                                console.log("Error requesting logs");
                                console.log(err);
                        })
                        let startTimestamp = dayjs(this.reportStartDate).unix();
                        let endTimestamp = dayjs(this.reportEndDate).unix();
                        let requestEndPoint = '/log.json?type=farm_harvest&timestamp[ge]=$[' + startTimestamp + ']&timestamp[le]=$[' + endTimestamp + ']';
                        console.log(startTimestamp);
                        console.log(endTimestamp);
                        
                        getAllPages(requestEndPoint, this.harvestLogs)
                        .catch((err) => {
                            console.log('An error occurred');
                            console.log(err);
                        })
                    }
                }
            });
            Vue.config.devtools = true;
        </script>
    </body>
</html>