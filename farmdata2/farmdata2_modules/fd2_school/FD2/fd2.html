<!DOCTYPE html>
<html>
<head>
    <title>Vue1</title>
</head>
<body>
    <h1 data-cy="page-header">Harvest Report</h1>
    <p>This page is a <i>mockup</i> of a simplified harvest report.</p>

    <div id="report" v-cloak>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="reportTitle" data-cy="title"/>
        <br>
        <br>
        <label for="start-date">Start:</label>
        <input data-cy="start-date" type="date" id="start-date" name="start-date" :min="reportStartDate" :max="reportEndDate" v-model="reportStartDate"/>
        <label for="end-date">End:</label>
        <input data-cy="end-date" type="date" id="end-date" name="end-date" :min="reportStartDate" max="reportEndDate" v-model="reportEndDate"/>
        <br>
        <br>
        <!-- <label for="crop">Crop:</label> -->
        <dropdown-with-all data-cy="crop"
            includes-all
            :selected-val="reportCrop"
            :dropdown-list="cropNames"
            @selection-changed="cropChange">
        Crop:
        </dropdown-with-all>
        <label for="field">Area:</label>
        <select id="field" name="field" v-model="reportArea" data-cy="area">
            <option v-for="area in areaNames">{{ area }}</option>
        </select>
        <br>
        <br>
        <button type="button" @click="generateReport" data-cy="generate-report-button">Generate Report</button>
        <hr>

        <h1 data-cy="report-title" v-if="hasTitle">{{ reportTitle }}</h1>

        <p>Details:</p>
        <ul data-cy="details" v-if="hasDetails">
            <li data-cy="farm-name"><strong>Farm</strong>:{{ farm }}</li>
            <li data-cy="username"><strong>User</strong>:{{ user }}</li>
            <li><strong>Language</strong>:<span data-cy="language">{{ language }}</span></li>
            <br>
            <li><strong>Start</strong>:<span data-cy="report-start-date">{{ reportStartDate }}</span></li>
            <li><strong>End</strong>:<span data-cy="report-end-date">{{ reportEndDate }}</span></li>
            <li><strong>Crop</strong>:<span data-cy="report-crop">{{ reportCrop }}</span></li>
        </ul>
        <br>
        <custom-table data-cy="test-table"
            :columns="columns"
            :rows="harvestReportRows"
            v-if="hasTable">

        </custom-table>
        <p v-if="harvestReportRows.length === 0" data-cy="no-record-message">There are no matching records!</p>
    </div>

    <script>
        var report = new Vue ({
            el: "#report",
            components: {
                "dropdown-with-all": DropdownWithAllComponent,
                'custom-table': CustomTableComponent,
            },
            data: {
                reportTitle: "My Sample Harvest Report",
                reportStartDate: "2020-05-05",
                reportEndDate: "2020-05-15",
                reportCrop: "All",
                reportArea: "All",
                harvestLogs: [],
                farm: "",
                user: "",
                language: "",
                idToCropMap: new Map(),
                idToAreaMap: new Map(),
                result: [],
                hasTitle: false,
                hasDetails: false,
                hasTable: false,

                columns: [
                    {"header": "ID", "visible": true, "inputType": {"type": "no input"}},
                    {"header": "Date", "visible": true, "inputType": {"type": "no input"}},
                    {"header": "Area", "visible": true, "inputType": {"type": "no input"}},
                    {"header": "Crop", "visible": true, "inputType": {"type": "no input"}},
                    {"header": "Yield", "visible": true, "inputType": {"type": "no input"}},
                    {"header": "Units", "visible": true, "inputType": {"type": "no input"}},
                ],
            },
            computed: {
                cropNames() {
                    let arr = Array.from(this.idToCropMap.values());
                    return arr;
                },
                areaNames() {
                    let arr = Array.from(this.idToAreaMap.values());
                    arr.unshift("All");
                    return arr;
                },

                harvestReportRows() {
                    let tableRows = [];
                    for (let log of this.result) {
                        let tableRow = {
                            id: log.id,
                            data: [
                                log.id,
                                dayjs.unix(log.timestamp).format("MM/DD/YYYY"),
                                log.area[0].name,
                                this.idToCropMap.get(log.data.crop_tid),
                                log.quantity[0].value,
                                log.quantity[0].unit.name,
                            ],
                        }
                        if (this.idToCropMap.get(log.data.crop_tid) === this.reportCrop) {
                            tableRows.push(tableRow);
                        }
                        else if (this.reportCrop === "All") {
                            tableRows.push(tableRow);
                        }
                    }
                    return tableRows;
                }
            },
            methods: {
                generateReport: function() {
                    axios.get("/farm.json")
                         .then((response) => {
                            this.farm = response.data.name;
                            this.user = response.data.user.name;
                            this.language = response.data.languages.en.name;
                         })
                         .catch((error) => {
                            console.log("Error Occurred");
                            console.log(error);
                         })
                    
                    let timestampStart = dayjs(this.reportStartDate).unix();
                    let timestampEnd = dayjs(this.reportEndDate).unix();
                    let request = "/log.json?type=farm_harvest&timestamp[ge]=" + timestampStart + "&timestamp[le]=" + timestampEnd;

                    this.result = [];
                    getAllPages(request, this.result)
                         .then(() => {})
                         .catch((error) => {
                            console.log("Error Occurred");
                            console.log(error);
                         })

                    this.hasTitle = true; // display the report title when the button is clicked
                    
                    this.hasDetails = true; // display "Details" when the button is clicked

                    this.hasTable = true; // display table when the button is clicked
                },
                deleteRow: function(rowIndex) {
                    this.harvestLogs.splice(rowIndex, 1);
                },
                cropChange(newCrop) {
                    this.reportCrop = newCrop;
                },
            },
            created() {
                getIDToCropMap()
                .then((cropMap) => {
                    this.idToCropMap = cropMap;
                })
                .catch((error) => {
                    console.log("Error Occurred");
                    console.log(error);
                });
                getIDToAreaMap()
                .then((areaMap) => {
                    this.idToAreaMap = areaMap;
                })
                .catch((error) => {
                    console.log("Error Occurred");
                    console.log(error);
                });
            },
        });
        Vue.config.devtools = true;
    </script>
</body>
</html>