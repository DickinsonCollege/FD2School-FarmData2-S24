<html>
    <head>
    </head>
    <body>
        <h1 data-cy="page-header">Harvest Report</h1>
        <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
  
        <div id="heading" v-cloak>
          <label for=title>Title:</label>
          <input type=”text” id=title name=title v-model="heading"/>   
        
          <br>
          <br>
          <label for="start">Start:</label>
          <input data-cy="start-date" type="date" id="start" name="start-date" v-model="startDate" min="2014-01-01" max="2022-01-01" :max="endDate"/>
          
          <label for="end">End:</label>
          <input data-cy="end-date" type="date" id="end" name="end-date" v-model="endDate" min="2020-05-05" max="2022-01-01" :min="startDate"/>
          <p></p>
          <br>
          <!-- <label for=title>Crop:</label> -->
          <dropdown-with-all data-cy="crop-dropdown" id="cropInDropdown" name="cropInDropdown" v-model="cropInDropdown"
                includes-all 
                :selected-val='cropInDropdown'
                :dropdown-list='cropNames'
                @selection-changed="cropChange">
                Crop: 
              <!-- <option v-for="name in cropNames">{{ name }}</option> -->
          </dropdown-with-all>
          
          <!-- <label for=title>Area:</label> -->
          <dropdown-with-all data-cy="area-dropdown" id="areaInDropdown" name="areaInDropdown" v-model="areaInDropdown"
                includes-all 
                :selected-val='areaInDropdown'
                :dropdown-list='areaNames'
                @selection-changed="areaChange">
                Area: 
            <!-- <option v-for="name in areaNames">{{ name }}</option> -->
          </dropdown-with-all>
          <p></p>
          <br>
          <button data-cy="generate-report-button" class="btn btn-primary" @click="buttonPress()">Generate Report</button>

          <hr>
          <div v-if="reportVisible">

            <h1 data-cy="report-header"> {{ heading == "" ? 'Mock Harvest Report' : heading}} </h1>    

            <p>Details:</p>
            <ul>
                <li data-cy="farm-name"><strong>Farm: </strong>{{ farm }}</li>
                <li data-cy="user-name"><strong>User: </strong>{{ user }}</li>
                <li><strong>Language: </strong><span data-cy="language">{{ language }}</span></li>
                <br>
                <li><strong>Start:</strong> {{ startDate }} </li>
                <li><strong>End:</strong> {{ endDate }} </li>
                <li><strong>Crop:</strong> {{ cropInDropdown }}</li>
            </ul>

            <custom-table 
                :columns="columns"
                :rows="harvestReportRowsForCustomTable">
                <!-- if length is zero -->
                <!-- <tr v-if="harvestReportRows.length == 0">
                    <th>There are no matching records.</th>
                </tr>
                <tr v-else>
                    <th>Row</th>
                    <th>Date</th>
                    <th>Area</th>
                    <th>Crop</th>
                    <th>Yield</th>
                    <th>Units</th>
                </tr>
                <tr v-for="(harvest, index) in harvestReportRows">
                    <td>{{ index+1 }}</td>
                    <td>{{ harvest.date }}</td>
                    <td>{{ harvest.area }}</td>
                    <td>{{ harvest.crop }}</td>
                    <td>{{ harvest.yield }}</td>
                    <td>{{ harvest.units }}</td>
                </tr> -->
            </custom-table>
        </div>
          </div>
          <script>
            var heading = new Vue({
                created() {
                    getIDToCropMap()
                    .then((theMap) => {
                        this.idToCropMap = theMap
                    })
                    .catch((error) => {
                        console.log("Error Occurred")
                        console.log(error)
                    })
                    getIDToAreaMap()
                    .then((theMap) => {
                        this.idToAreaMap = theMap
                    })
                    .catch((error) => {
                        console.log("Error Occurred")
                        console.log(error)
                    })
                },
                el: "#heading",
                data: {
                    state: "default",
                    heading: "My Sample Report",
                    startDate: "2020-05-05",
                    endDate: "2020-05-15",
                    //crop: "Kale",         
                    reportVisible: false,
                    farm: "",
                    user: "",
                    language: "",
                    idToCropMap: new Map(),
                    idToAreaMap: new Map(),
                    results: [],
                    cropInDropdown: "All",
                    areaInDropdown: "All",
                    columns: [
                        {"header": 'Date', "visible": true, "inputType": {'type': 'no input'}},
                        {"header": 'Area', "visible": true, "inputType": {'type': 'no input'}},
                        {"header": 'Crop', "visible": true, "inputType": {'type': 'no input'}},
                        {"header": 'Yield', "visible": true, "inputType": {'type': 'no input'}},
                        {"header": 'Units', "visible": true, "inputType": {'type': 'no input'}},],
                },
                computed: {
                    cropNames(){
                        return Array.from(this.idToCropMap.values());
                    },
                    areaNames(){
                        return Array.from(this.idToAreaMap.values());
                    },
                    // harvestReportRows() {
                    //     let tableRows = []
                    //     for(let result of this.results) {
                    //         let tableRow = {
                    //             date: dayjs.unix(result.timestamp).format('YYYY-MM-DD'),
                    //             area: result.area[0].name,
                    //             yield: result.quantity[0].value,
                    //             units: result.quantity[0].unit.name,
                    //             crop: this.idToCropMap.get(result.data.crop_tid)
                    //         }                            
                    //         if ((this.areaInDropdown === tableRow.area) && (this.cropInDropdown === tableRow.crop)){
                    //             tableRows.push(tableRow)
                    //         } 
                    //         if(this.cropInDropdown === "All"){
                    //             tableRows.push(tableRow)
                    //         }
                    //     }
                    //     return tableRows
                        
                    // },
                    harvestReportRowsForCustomTable(){
                        let tableRows = []
                        for(let log of this.results){
                            let tableRow = {
                                id: log.id,
                                data: [
                                    dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                                    log.area[0].name,
                                    this.idToCropMap.get(log.data.crop_tid),
                                    log.quantity[0].value,
                                    log.quantity[0].unit.name,
                                ], 
                            }
                            if ((this.cropInDropdown === tableRow.data[2])){
                                tableRows.push(tableRow)
                            } 
                            // if ((this.areaInDropdown === tableRow.data[1])){
                            //     tableRows.push(tableRow)
                            // } 
                            if(this.cropInDropdown === "All"){
                                tableRows.push(tableRow)
                            }
                        }
                        return tableRows
                    },
                },
                methods: {
                    buttonPress: function() {
                            axios.get('/farm.json')  // this line sends the request.
                            .then((response) => {
                                // Block A:
                                this.farm=response.data.name
                                this.user=response.data.user.name
                                this.language=response.data.languages.en.name
                                this.reportVisible=true
                            })
                            .catch((error) => {
                                // Block B: 
                                console.log("Error Occurred")
                                console.log(error)
                            })
                            // Block C: 
                            let timestampS = dayjs(this.startDate).unix()
                                
                                let timestampE = dayjs(this.endDate).unix()
                                
                                var request = "/log.json?type=farm_harvest&timestamp[ge]=" + timestampS + "&timestamp[le]=" + timestampE
                                
                            getAllPages(request, this.results)
                                .then(() => {   
                                

                            })
                            .catch((err) => {
                                console.log("Error Occurred")
                                console.log(error)
                            })
                            
                            if(!this.reportVisible){
                                this.reportVisible=true
                            }
                    },
                    cropChange(newCrop) {
                        this.cropInDropdown = newCrop
                    },
                    areaChange(newArea) {
                        this.areaInDropdown = newArea
                    },
                },
                components: {
                    'dropdown-with-all': DropdownWithAllComponent,
                    'custom-table': CustomTableComponent,

                },
            });
            Vue.config.devtools = true;
          </script>

    </body>
</html>