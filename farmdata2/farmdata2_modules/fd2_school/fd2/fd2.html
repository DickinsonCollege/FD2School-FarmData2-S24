<h1 data-cy="page-header">Harvest Report</h1>
<p>This page is a <dfn>mockup</dfn> of a simplified harvest report.</p>
<hr>
<h1>My Sample Harvest Report</h1>

<div id="reportdetails">
        <label>Title:</label>
        <input type="text" id="reportdetails" v-model="header">

        <br></br>

        <label for="Start Date">Start:</label>
        <input type="date" v-model="reportStartDate" v-bind:max="reportEndDate" data-cy="start-date"/>
        <label for="End Date">End:</label>
        <input type="date" v-model="reportEndDate" v-bind:min="reportStartDate" data-cy="end-date"/>
        <br>
        <br>
        <label for="Crop">Crop:</label>
        
        <select data-cy="crop-dropdown">
                <option v-for="crop in getCropNames">{{crop}}</option>
        </select>

        <label for="Field">Area:</label>
        <select id="Field" name ="Field">
                <option v-for="area in areas">{{area}}</option>
        </select>
        <br>
        <br>
        <input data-cy="generate-report-button" type="button" value="Generate Report" v-on:click=generateReport>
        <br>
        <hr></hr>
        <div v-if="headerVisible === 'true'">

            <h1 data-cy="report-header"> {{ header ? header : "Mock Harvest Report" }} </h1>

            <p>Details:</p>
            <ul>
            <li data-cy="farm-name"><strong>Farm: </strong>{{ farm }}</li>
            <li data-cy="user"><strong>User: </strong>{{ user }}</li>
            <li><strong>Language: </strong><span data-cy="language">{{ language }}</span></li>
            <br>
            <li><strong>Start: </strong>{{ reportStartDate }}</li>
            <li><strong>End: </strong>{{ reportEndDate }}</li>
            <li><strong>Crop:</strong>{{ reportCrop }}</li>
            </ul>
            
            <div v-if="logs.length!=0">
                <table border="1">
                    <tr>
                            <th>Row</th>
                            <th>Date</th>
                            <th>Area</th>
                            <th>Crop</th>
                            <th>Yield</th>
                            <th>Units</th>
                    </tr>
                    <tr v-for="(log, index) in harvestReportRows">
                            <td>{{ index+1 }}</td>
                            <td>{{ log.date }}</td>
                            <td>{{ log.area }}</td>
                            <td>{{ log.crop }}</td>
                            <td>{{ log.yield }}</td>
                            <td>{{ log.units }}</td>
                    </tr>
                </table>
            </div>
            <div v-else>
                <p>No matching records.</p>
            </div>
    </div>
</div>

<script>
    var vObj = new Vue({
        el: "#reportdetails",
        data: {
            header: "My Sample Harvest Report",
            headerVisible: "false",
            reportStartDate: "2020-05-05",
            reportEndDate: "2020-05-15",
            reportCrop: "Kale",
            areas: ["All", "Chuau-1", "SQ7"],
            logs: [],
            farm: "",
            user: "",
            language: "",
            idToCropMap: new Map(),
            pages: [],
        },
        methods: {
            generateReport: function(){
                axios.get('/farm.json')
                .then((response) => {
                    this.headerVisible = "true";
                    this.farm = response.data.name;
                    this.user = response.data.user.name;
                    this.language = response.data.user.language;
                    let startTimestamp = dayjs(this.reportStartDate).unix();
                    let endTimestamp = dayjs(this.reportEndDate).unix();

                    let string = `/log.json?type=farm_harvest&timestamp[ge]=${startTimestamp}&timestamp[le]=${endTimestamp}`;
                    getAllPages(string, this.logs)
                    .then(() => {
                        console.log(this.logs);
                    })
                    .catch((err) => {
                        console.log("Error fetching result");
                    })
                })
                .catch((error) => {
                    console.log("Error occurred getting /farm.json");
                    console.log(error);
                })
            }
        },
        computed: {
            getCropNames() {
                return Array.from(this.idToCropMap.values());
            },
            harvestReportRows() {
                let tableRows = [];
                for(let log of this.logs) {
                    let tableRow = {
                        date: dayjs(log.timestamp).format('MM/DD/YYYY'),
                        area: log.area[0].name,
                        crop: this.idToCropMap.get(log.data.crop_tid),
                        yield: log.quantity[0].value,
                        units: log.quantity[0].unit.name,
                    }
                    tableRows.push(tableRow);
                }
                return tableRows;
            },
        },
        created(){
            getIDToCropMap()
            .then((theMap) => {
                this.idToCropMap = theMap;
            })
            .catch((err) => {
                console.log("Map not received");
            })
            console.log("HarvestReport vue instance created!")
        },
    });
    Vue.config.devtools = true;
</script>