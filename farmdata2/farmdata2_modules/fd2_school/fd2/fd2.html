<body>
    <h1 data-cy="page-header">Harvest Report</h1>
    <p>This page is a <i>mockup</i> of a simplified harvest report.</p>

    <div id="app" v-cloak>
        <label for="reportTitle">Title:</label>
        <input type="text" v-model="reportTitle" size="21" id="reportTitle" name="reportTitle"/>


    <br></br>

    <label for="start">Start:</label>
    <input data-cy="start-date" type="date" id="start" name="start" :min="2014-01-01" :max="reportEndDate" v-model="reportStartDate"/>

    <label for="end">End:</label>
    <input data-cy="end-date" type="date" id="end" name="end" :min="reportStartDate" :max="2022-01-01" v-model="reportEndDate"/>

    <br></br>


    <dropdown-with-all data-cy="crop-list"
        includes-all
        :selected-val="reportSelectedCrop"
        :dropdown-list="cropNames"
        @selection-changed="cropChange"
        >
    Crop: 
    </dropdown-with-all>
   

    <label for="area">Area:</label>
    <select v-model="reportSelectedArea" id="area" name="area">
        <option v-for="areas in areaList" value="areas">{{ areas }}</option>
    </select>

    <br></br>
    <button data-cy="generate-report" class="btn btn-primary" @click="generateReport">Generate Report</button>



    <hr></hr>
    <div v-if="reportGenerated === 'true'">
    <h1 data-cy="report-title">{{reportTitle ? reportTitle : "Mock Harvest Report"}}</h1>
    <p>Details:</p>
    <ul>
        <li data-cy="farm-name"><strong>Farm: </strong> {{ farm }}</li>
        <li data-cy="user"><strong>User: </strong>{{ user }}</li>
        <li><strong>Language: </strong><span data-cy="language">{{ language }}</span></li>
        <br></br>
        <li><strong>Start: </strong>{{ reportStartDate }}</li>
        <li><strong>End: </strong>{{ reportEndDate }}</li>
        <li><strong>Crop: </strong>{{ reportSelectedCrop }}</li> 
    </ul>
    <div v-if="harvestReportRows.length > 0">
        <table border="1">
            <tr>
                <th>Row</th>
                <th>Date</th>
                <th>Area</th>
                <th>Crop</th>
                <th>Yield</th>
                <th>Units</th>
            </tr>
            <tr v-for="(log,index) in harvestReportRows">
                <td>{{index+1}}</td>
                <td>{{log.date}}</td>
                <td>{{log.area}}</td>
                <td>{{log.crop}}</td>
                <td>{{log.yield}}</td>
                <td>{{log.units}}</td>
            </tr>
        </table>
    </div>
    <p v-else>No matching records found</p>
    </div>
    </div>

    <script>
var app = new Vue({
    el: "#app",
    components: {
        'dropdown-with-all': DropdownWithAllComponent,
    },
    data: {
        reportTitle: "My Sample Harvest Report",
        reportStartDate: "2020-05-05",
        reportEndDate: "2020-05-15",
        reportSelectedCrop: "All",
        reportSelectedArea: "",
        areaList: ["ALL", "SQ7", "Chuau-1"],
        harvestLogs: [],
        farm: "",
        user: "",
        language: "",
        idToCropMap: new Map(),
        allHarvestLogs: [],
        reportGenerated: "false"
    },
    methods: {

        cropChange(newCrop) {
            this.reportSelectedCrop = newCrop
        },

        generateReport: function() {

            // Axios request
            axios.get('/farm.json')
                .then((response) => {
                    // Set farm, user, and language
                    this.farm = response.data.name;
                    this.user = response.data.user.name;
                    this.language = response.data.user.language;
                    this.reportGenerated = "true";
                    let startTimestamp = dayjs(this.reportStartDate).unix();
                    let endTimestamp = dayjs(this.reportEndDate).unix();
                    let requestString = `/log.json?type=farm_harvest&timestamp[ge]=${startTimestamp}&timestamp[le]=${endTimestamp}`;
                  
                    console.log(requestString);
                    console.log(startTimestamp);
                    console.log(endTimestamp);

                    getAllPages(requestString, this.allHarvestLogs)
                    .then(() => {
                        console.log("All pages of harvest logs fetched");
                    
                    })
                    .catch((err) => {
                        console.log("Error while fetching");
                    })
                })
                .catch((error) => {
                    console.log("Error Occurred");
                    console.log(error);
                });
        }
    },

    computed: {
        cropNames() {
            return Array.from(this.idToCropMap.values());
        },
        harvestReportRows() {
            let tableRows = [];
            for(let log of this.allHarvestLogs) {
                let harvestQuantity = log.quantity.find(qty => qty.label == 'Harvest');
                let yieldValue = harvestQuantity.value;
                let unit = harvestQuantity.unit.name;
                let cropName = this.idToCropMap.get(log.data.crop_tid);

                if (this.reportSelectedCrop === cropName || this.reportSelectedCrop === "All"){
                let tableRow = {
                    date: dayjs.unix(log.timestamp).format('DD/MM/YYYY'),
                    area:log.area[0].name,
                    yield: yieldValue,
                    units: unit,
                    crop: cropName,

                };
                tableRows.push(tableRow);
            }
        }
            return tableRows;
        }
    },

    created() {
        // Call getIDToCropMap and set idToCropMap
        getIDToCropMap()
            .then((theMap) => {
                this.idToCropMap = theMap;;
                
            })
            .catch((err) => {
                console.log("Map not received");
            });
    }
});

Vue.config.devtools = true;

    </script>

</body>